# 프로세스와 쓰레

## 멀티태스킹과 멀테프로세싱

멀티스레드에 대해서 제대로 이해하려면 먼저 멀티태스킹과 프로세스 같은 운영체제의 기본 개념들에 대해서 알아야한다. 

여기서는 멀티스레드를 이해하기 위한 목적으로 최대한 단순하게 핵심 내용만 알아보겠다.

* 단일 프로그램 실행

만약 프로그램을 2개 이상 동시에 실행한다고 가정해보자. 

예를 들어서 음악 프로그램을 통해 음악을 들으면서, 동시에 워드 프로그램을 통해 문서를 작성하는 것이다. 

여기서는 연산을 처리할 수 있는 CPU 코어가 1개만 있다고 가정하겠다.

**그림1 - 프로그램A의 코드1 실행 시작**

![image](https://github.com/user-attachments/assets/63854f66-8c22-4185-8c3a-9a7b23c6b8da)

**그림2 - 프로그램A의 코드2 실행 중**

![image](https://github.com/user-attachments/assets/0f2d4a39-d75a-46ae-a2c1-7330b7b74489)

**그림3 - 프로그램A의 실행 완료**

![image](https://github.com/user-attachments/assets/bd40e4d9-4c66-4c5f-8a83-44bc1705814e)

**그림4 - 프로그램B 실행 시작**

![image](https://github.com/user-attachments/assets/d97b0947-08c1-47b9-ab54-d7ce14d20576)

**그림5 - 프로그램A 완료후 프로그램 B완료**

![image](https://github.com/user-attachments/assets/825edec6-7e8d-45a3-bd54-dc9545bbef81)

프로그램의 실행이란 프로그램을 구성하는 코드를 순서대로 CPU에서 연산(실행)하는 일이다.

여기서 CPU 코어는 하나로 가정하므로, 한 번에 하나의 프로그램 코드만 실행할 수 있다.

이때, 하나의 프로그램 안에 있는 코드를 모두 실행한 후에야 다른 프로그램의 코드를 실행할 수 있다면? 

예를 들어 음악 프로그램이 끝난 뒤에야 워드 프로그램을 실행할 수 있다면 컴퓨터 사용자는 매우 답답할 것이다.

실제로 초창기의 컴퓨터는 이 처럼 한 번에 하나의 프로그램만 실행했다.

이를 해결하기 위해 하나의 CPU 코어로 여러 프로그램을 동시에 실행하는 '멀티태스킹' 기술이 등장했다.

**멀티태스킹**

순서대로 촬영한 연속된 사진을 빠르게 교차해서 보여줄 경우 사람은 이를 움직이는 영상으로 인지한다. 

애니메이션이바로 이 원리를 이용한다. 예를 들어 우리가 애니메이션을 볼 때 1초에 30 ~ 60장의 사진이 지나간다. 

이 정도 속도면 사람은 사진이 아니라 연속해서 움직이는 영상으로 인지한다. 

현대의 CPU는 초당 수십억 번 이상의 연산을 수행한다.

쉽게 이야기해서 초당 수십억 장의 사진이 빠르게 교차되는 것이다.

만약 CPU가 매우 빠르게 두 프로그램의 코드를 번갈아 수행한다면, 사람이 느낄 때 두 프로그램이 동시에 실행되는 것처럼 느껴질 것이다. (대략 0.01초(10ms) 단위로 돌아가며 실행한다.)

**그림1**

![image](https://github.com/user-attachments/assets/f41ac20e-a81c-4040-9f04-c224855710c0)

**그림1 - 프로그램B의 코드1 수행**

![image](https://github.com/user-attachments/assets/4b255fd8-c4a3-445c-8740-9250c67e3283)

**그림3 - 프로그램 수행 완료**

![image](https://github.com/user-attachments/assets/e1240ea1-3b0b-48bf-9bd7-c3134e87ec75)

이 방식은 CPU 코어가 프로그램A의 코드를 0.01초 정도 수행하다가 잠시 멈추고, 프로그램B의 코드를 0.01초 정도 수행한다. 

그리고 다시 프로그램A의 이전에 실행중인 코드로 돌아가서 0.01초 정도 코드를 수행하는 방식으로 반복 동작한다.

이렇게 각 프로그램의 실행 시간을 분할해서 마치 동시에 실행되는 것 처럼 하는 기법을 시분할(Time Sharing, 시간공유) 기법이라 한다. 

이런 방식을 사용하면 CPU 코어가 하나만 있어도 여러 프로그램이 동시에 실행되는 것 처럼 느낄수 있다.

이렇게 하나의 컴퓨터 시스템이 동시에 여러 작업을 수행하는 능력을 멀티태스킹(Multitasking)이라 한다.

**참고**: CPU에 어떤 프로그램이 얼마만큼 실행될지는 운영체제가 결정하는데 이것을 스케줄링(Scheduling)이라한다. 

이때 단순히 시간으로만 작업을 분할하지는 않고, CPU를 최대한 활용할 수 있는 다양한 우선순위와 최적화 기법을 사용한다. 

우리는 운영체제가 스케줄링을 수행하고, CPU를 최대한 사용하면서 작업이 골고루 수행될 수 있게 최적화한다는 정도로 이해하면 충분하다. 

자세한 내용이 궁금한 분들은 운영체제 이론을 참고하자

멀티프로세싱 CPU 코어가 둘 이상이면 어떻게 될까?

여기서는 프로그램은 A, B, C 3가지이고, CPU 코어는 2개이다.

CPU 안에는 실제 연산을 처리할 수 있는 코어라는 것이 있다. 

과거에는 하나의 CPU 안에 보통 하나의 코어만 들어있었다. 

그래서 CPU와 코어를 따로 분리해서 이야기하지 않았다. 최근에는 하나의 CPU 안에 보통 2개이상의 코어가 들어있다.

**그림1 - 프로그램A, 프로그램B 실행**

![image](https://github.com/user-attachments/assets/ab5110b6-3a03-42b0-9dd5-cc8c9ca42443)

CPU 코어가 2개이므로 물리적으로 동시에 2개의 프로그램을 처리할 수 있다.

여기서는 CPU 코어가 먼저 프로그램A와 프로그램B를 실행한다.

**그림2 - 프로그램C, 프로그램A 실행**

![image](https://github.com/user-attachments/assets/5062a4e7-e849-405a-a066-ee5a44f3d7fc)

CPU 코어들이 프로그램A와 프로그램B를 실행하다가 잠시 멈추고, 프로그램C와 프로그램A를 수행한다. 이런식으로 코어가 2개여도 2개보다 더 많은 프로그램을 실행할 수 있다.

**그림3 - 실행 완료**

![image](https://github.com/user-attachments/assets/3cfc53c3-721c-44ae-a754-89ce010eedc5)

**멀티프로세싱 vs. 멀티태스킹**

멀티프로세싱은 하드웨어 장비의 관점이고, 멀티태스킹은 운영체제 소프트웨어의 관점이다.

**멀티프로세싱**

여러 CPU(여러 CPU 코어)를 사용하여 동시에 여러 작업을 수행하는 것을 의미한다.

하드웨어 기반으로 성능을 향상시킨다.

예: 다중 코어 프로세서를 사용하는 현대 컴퓨터 시스템

**멀티태스킹**
단일 CPU(단일 CPU 코어)가 여러 작업을 동시에 수행하는 것처럼 보이게 하는 것을 의미한다.

소프트웨어 기반으로 CPU 시간을 분할하여 각 작업에 할당한다.

예: 현대 운영 체제에서 여러 애플리케이션이 동시에 실행되는 환경

참고로 이 예는 여러 CPU 코어를 사용하기 때문에 멀티프로세싱이다. 동시에 각각의 단일 CPU 코어에 여러 작업을 분할해서 수행하기 때문에 멀티태스킹이다.

## 프로세스와 스레드

![image](https://github.com/user-attachments/assets/2922b4dc-452c-49de-ad57-2de64d8f64aa)

### 프로세스

프로그램은 실제 실행하기 전까지는 단순한 파일에 불과하다.

프로그램을 실행하면 프로세스가 만들어지고 프로그램이 실행된다.

이렇게 운영체제 안에서 **실행중인 프로그램을 프로세스**라 한다.

프로세스는 실행 중인 프로그램의 **인스턴스**이다.

자바 언어로 비유를 하자면 클래스는 프로그램이고, 인스턴스는 프로세스이다.

프로세스는 실행 중인 프로그램의 인스턴스이다. 

각 프로세스는 독립적인 메모리 공간을 갖고 있으며, 운영체제에서 별도의 작업 단위로 분리해서 관리된다. 

각 프로세스는 별도의 메모리 공간을 갖고 있기 때문에 서로 간섭하지 않는다. 

그리고 프로세스가 서로의 메모리에 직접 접근할 수 없다.

프로세스는 이렇듯 서로 격리되어 관리되기 때문에, 하나의 프로세스가 충돌해도 다른 프로세스에는 영향을 미치지 않는다. 

쉽게 이야기해서 특정 프로세스(프로그램)에 심각한 문제가 발생하면 해당 프로세스만 종료되고, 다른 프로세스에 영향을 주지 않는다.

**프로세스의 메모리 구성**

* **코드 섹션**: 실행할 프로그램의 코드가 저장되는 부분
* **데이터 섹션**: 전역 변수 및 정적 변수가 저장되는 부분(그림에서 기타에 포함)
* **힙 (Heap)**: 동적으로 할당되는 메모리 영역
* **스택 (Stack)**: 메서드(함수) 호출 시 생성되는 지역 변수와 반환 주소가 저장되는 영역(스레드에 포함)

### 스레드 (Thread)

**프로세스는 하나 이상의 스레드를 반드시 포함한다.**

스레드는 프로세스 내에서 실행되는 작업의 단위이다. 

한 프로세스 내에서 여러 스레드가 존재할 수 있으며, 이들은 프로세스가 제공하는 동일한 메모리 공간을 공유한다. 

스레드는 프로세스보다 단순하므로 생성 및 관리가 단순하고 가볍다.

**메모리 구성**
* **공유 메모리**: 같은 프로세스의 코드 섹션, 데이터 섹션, 힙(메모리)은 프로세스 안의 모든 스레드가 공유한다.
* **개별 스택**: 각 스레드는 자신의 스택을 갖고 있다.

**프로그램이 실행된다는 것은 어떤 의미일까?**

프로그램을 실행하면 운영체제는 먼저 디스크에 있는 파일 덩어리인 프로그램을 메모리로 불러오면서 프로세스를 만든다. 

그럼 만들어진 프로세스를 어떻게 실행할까?

프로그램이 실행된다는 것은 사실 프로세스 안에 있는 코드가 한 줄씩 실행되는 것이다. 

코드는 보통 `main()` 부터 시작해서 하나씩 순서대로 내려가면서 실행된다.

```java
public class Operator {
  public static void main(String[] args) {
    int sum1 = 1;
    int sum2 = sum1 + 1;
    System.out.println("sum1 = " + sum1);
    System.out.println("sum2 = " + sum2);
  }
}
```

생각해보면 어떤 무언가가 코드를 하나씩 순서대로 실행하기 때문에 프로그램이 작동하고 계산도 하고, 출력도 할 수 있다.

이 코드를 하나씩 실행하면서 내려가는 것의 정체가 무엇일까?

비유를 하자면 마치 실(thread) 같은 것이 코드를 위에서 아래로 하나씩 꿰면서 하나씩 내려가는 것 같다.

이렇듯 프로세스의 코드를 실행하는 흐름을 스레드(thread)라 한다. 

스레드는 번역하면 "실", "실을 꿰다"라는 뜻이다.

스레드는 프로세스 내에서 실행되는 작업의 단위이다. 

한 프로세스 내에 하나의 스레드가 존재할 수 있고, 한 프로세스내에 여러 스레드가 존재할 수도 있다. 

그리고 스레드는 프로세스가 제공하는 동일한 메모리 공간을 공유한다.

* **단일 스레드**: 한 프로세스 내에 하나의 스레드만 존재
* **멀티 스레드**: 한 프로세스 내에 여러 스레드가 존재

**하나의 프로세스 안에는 최소 하나의 스레드가 존재**한다. 

그래야 프로그램이 실행될 수 있다.

참고로 우리가 지금까지 작성한 자바 코드들은 모두 한 프로세스 내에서 하나의 스레드만 사용하는 단일 스레드였다.

정리하면 프로세스는 실행 환경과 자원을 제공하는 컨테이너 역할을 하고, 스레드는 CPU를 사용해서 코드를 하나하나 실행한다.

**멀티스레드가 필요한 이유**

하나의 프로그램도 그 안에서 동시에 여러 작업이 필요하다.

워드 프로그램으로 문서를 편집하면서, 문서가 자동으로 저장되고, 맞춤법 검사도 함께 수행된다.

유튜브는 영상을 보는 동안, 댓글도 달 수 있다.

운영제체 관점에서 보면 다음과 같이 구분할 수 있다.

**워드 프로그램 - 프로세스A**

스레드1: 문서 편집

스레드2: 자동 저장

스레드3: 맞춤법 검사

**유튜브 - 프로세스B**

스레드1: 영상 재생

스레드2: 댓글

## 스레드와 스케줄링
앞서 멀티태스킹에서 설명한 운영체제의 스케줄링을 과정을 더 자세히 알아보자.

CPU 코어는 1개이고, 프로세스는 2개이다. 프로세스 A는 스레드1개 프로세스B는 스레드가 2개 있다.

프로세스는 실행 환경과 자원을 제공하는 컨테이너 역할을 하고, 실제 CPU를 사용해서 코드를 하나하나 실행하는 것은 스레드이다.

![image](https://github.com/user-attachments/assets/ffb12bd4-3129-4dd7-9111-bc36efd1caac)

프로세스A에 있는 스레드A1을 실행한다.

![image](https://github.com/user-attachments/assets/2d4a3838-f141-4d0a-bff0-ed201b243b10)

프로세스A에 있는 스레드A1의 실행을 잠시 멈추고 프로세스B에 있는 스레드 B1을 실행한다.

![image](https://github.com/user-attachments/assets/37555ebf-9f83-4c14-9a68-97c46d541de3)

프로세스B에 있는 스레드 B1의 실행을 잠시 멈추고 같은 프로세스의 스레드 B2를 실행한다.

이후에 프로세스A에 있는 스레드A1을 실행한다.

이 과정을 반복한다.

### 단일 코어 스케줄링

운영체체가 스레드를 어떻게 스케줄링 하는지, 스케줄링 관점으로 알아보자.

운영체제는 내부에 스케줄링 큐를 가지고 있고, 각각의 스레드는 스케줄링 큐에서 대기한다.










